<ng-container *ngIf="isSubmitted; else takeQuiz">
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6 w-full max-w-4xl mx-auto">
    <h3 class="text-2xl font-bold text-center text-slate-800 dark:text-white mb-2">Quiz Completed!</h3>
    <p class="text-center text-4xl font-extrabold text-sky-600 dark:text-sky-400 mb-6">{{ score.toFixed(0) }}%</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-3">
            <h4 class="text-lg font-semibold text-slate-800 dark:text-white">Your Answers</h4>
            <div *ngFor="let q of quiz.questions; let i = index" class="p-4 border rounded-md border-slate-200 dark:border-slate-700">
              <p class="font-semibold text-slate-700 dark:text-slate-200">{{ i + 1 }}. {{ q.question }}</p>
              <ul class="mt-2 space-y-1">
                  <li *ngFor="let opt of q.options" class="text-sm flex items-center" 
                    [ngClass]="{
                      'text-green-600 dark:text-green-400 font-medium': opt === q.correctAnswer,
                      'text-red-500 dark:text-red-400 font-medium': opt === finalAnswers[i] && opt !== q.correctAnswer,
                      'text-slate-600 dark:text-slate-400': opt !== q.correctAnswer && opt !== finalAnswers[i],
                      'font-medium': opt === finalAnswers[i]
                    }">
                    <span class="mr-2">
                      {{ opt === q.correctAnswer ? '✓' : (opt === finalAnswers[i] ? '✗' : '•') }}
                    </span>
                    {{ opt }}
                  </li>
              </ul>
            </div>
        </div>
        <app-ai-performance-review [questions]="quiz.questions" [userAnswers]="finalAnswers" [score]="score"></app-ai-performance-review>
    </div>
    <div *ngIf="quiz.retakeAllowed" class="mt-6 text-center">
        <button (click)="retake.emit()" class="px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-sky-600 hover:bg-sky-700">
            Retake Quiz
        </button>
    </div>
  </div>
</ng-container>

<ng-template #takeQuiz>
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow-lg p-6 w-full max-w-2xl mx-auto">
    <h2 class="text-2xl font-bold text-center text-slate-800 dark:text-white mb-2">{{ quiz.title }}</h2>
    <p class="text-center text-slate-500 dark:text-slate-400 mb-6">{{ quiz.questions.length }} questions</p>

    <div class="my-6 min-h-[250px]">
      <h3 class="text-lg font-semibold text-slate-700 dark:text-slate-200 mb-4">{{ currentQuestionIndex + 1 }}. {{ currentQuestion.question }}</h3>
      <div class="space-y-3">
        <button *ngFor="let option of currentQuestion.options"
          (click)="handleAnswerSelect(option)"
          class="w-full text-left p-4 rounded-lg border-2 transition-colors"
          [ngClass]="userAnswers[currentQuestionIndex] === option ? 'bg-sky-100 dark:bg-sky-900/50 border-sky-500' : 'bg-slate-50 dark:bg-slate-700/50 border-transparent hover:border-sky-300'">
          {{ option }}
        </button>
      </div>
    </div>

    <div class="flex justify-between items-center mt-6">
      <button (click)="previousQuestion()" [disabled]="currentQuestionIndex === 0" class="px-4 py-2 border border-slate-300 text-sm font-medium rounded-md disabled:opacity-50">
        Previous
      </button>
      <span class="text-sm font-medium text-slate-500 dark:text-slate-400">
        Question {{ currentQuestionIndex + 1 }} of {{ quiz.questions.length }}
      </span>
      <button *ngIf="currentQuestionIndex === quiz.questions.length - 1; else nextButton" (click)="handleSubmit()" class="px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700">
        Submit
      </button>
      <ng-template #nextButton>
        <button (click)="nextQuestion()" class="px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-sky-600 hover:bg-sky-700">
          Next
        </button>
      </ng-template>
    </div>
  </div>
</ng-template>
